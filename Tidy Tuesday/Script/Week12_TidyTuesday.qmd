---
title: "Global TB"
subtitle: "Tidy Tuesday Week 12"
author: "Jordan Vest"
date: today
format: 
  html:
    toc: true
    toc-title: "Are you lost? Look here!" 
    theme: darkly
    smooth-scroll: true 
    respect-user-color-scheme: true 
    link-external-newwindow: true
    linkcolor: pink 
    page-layout: article
---

## Get Ready for Plotting

### Load libraries
```{r}
#| message: false
#| warning: false
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
```

### Load data
```{r}
#| message: false
#| warning: false
who_tb_data <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-11-11/who_tb_data.csv')
```

### Reorganize data
```{r}
#| message: false
#| warning: false
tb_subset <- who_tb_data %>%
  select(year, g_whoregion, e_inc_100k)
```

### Clean it up 
```{r}
#| message: false
#| warning: false
tb_cleaned <- tb_subset %>%
  # Remove rows where region or incidence data is missing
  filter(!is.na(g_whoregion), !is.na(e_inc_100k))
```

### Regroup
```{r}
tb_trends <- tb_cleaned %>%
  # Group the data by year and region
  group_by(year, g_whoregion) %>%
  # Find the average incidence for each group
  summarise(
    avg_incidence = mean(e_inc_100k, na.rm = TRUE),
    .groups = 'drop' # Recommended command to remove the grouping after summarising
  )
```

## Iterate some plots
Using [DatatoViz](https://www.data-to-viz.com/#histogram) to figure out what plot makes the most sense for two continuous variables. A line chart to show the time series by year will work. 

### Make a time-series plot
```{r}
#| message: false
#| warning: false
tb_plot_basic <- tb_trends %>%
  ggplot(aes(x = year, y = avg_incidence, group = g_whoregion, color = g_whoregion)) +
  geom_line(linewidth = 1)+
# Set the labels for the axes and title
  labs(
    title = "Estimated TB Incidence Rate Trends by WHO Region",
    x = "Year",
    y = "Average Estimated Incidence per 100,000 Population",
    color = "WHO Region" # Label for the legend
  ) +
  # Make it pretty
  scale_color_viridis_d(option = "D")+ 
  theme_minimal(base_size = 14) +
  theme(
    # Move the legend to the top for better visual
    legend.position = "top", 
    # Center the plot title
    plot.title = element_text(hjust = 0.5, face = "bold"),
    # Remove minor grid lines
    panel.grid.minor = element_blank() 
  )
print(tb_plot_basic) # Uncomment to view the plot
```

```
### Learning new things
The first plot looks okay but it is a little difficult to see what color aligns with what region. I thought it would be nice to label the lines directly. Looked up how to do this and started playing with geom_text.

In order to label the far right of the plot I need to find the last data point for each region. 

### Create the New Labeled Plot 
```{r}
#| message: false
#| warning: false
latest_data <- tb_trends %>%
  filter(year == max(year))
  
tb_plot_labeled <- tb_trends %>%
  ggplot(aes(x = year, y = avg_incidence, group = g_whoregion, color = g_whoregion)) +
  geom_line(linewidth = 1) +
  # (The NEW SKILL)
  geom_text(
    data = latest_data, # Use the filtered data frame
    aes(label = g_whoregion), # Use the label from the dataset
    hjust = 0, # Align the text to the right of the point
    nudge_x = 0.5, # Push the text slightly to the right so it doesn't overlap the line end
    fontface = "bold"
  ) +
  labs(
    title = "Estimated TB Incidence Rate Trends by WHO Region",
    subtitle = "Comparing average estimated incidence per 100,000 people over time",
    x = "Year",
    y = "Average Estimated Incidence",
    caption = "Data Source: WHO Tuberculosis Data."
  ) +
  scale_color_viridis_d(option = "D") + 
  
  theme_minimal(base_size = 14) +
  theme(
    # Remove the legend since we have direct labels
    legend.position = "none", 
    plot.title = element_text(hjust = 0, face = "bold"), #left justify labels
    plot.subtitle = element_text(hjust = 0),
    plot.caption = element_text(hjust = 0),
    panel.grid.minor = element_blank(),
    # Increase the right margin so the labels don't get cut off
    plot.margin = margin(10, 150, 10, 10) 
  ) +
  # Ensure the labels are not clipped by the plot boundaries
  coord_cartesian(clip = "off") 

print(tb_plot_labeled) #Uncomment to print
```


# New Knowledge
Using geom_text I was able to move the labels from the legend to directly beside the line they represent making the visualization much easier. I learned to filter the data for the last data point to put this on the far right of the plot. 
Not happy that Americans and Europe slightly overlap but couldn't find a simple way to separate. Any thoughts? 


