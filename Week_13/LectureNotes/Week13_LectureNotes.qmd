---
title: "Week13_LectureNotes"
subtitle: "Iterative coding"
format: html
date: today
---

## Final Project
it's due soon!!!!? 12/2 - office hours next week?
* needs to be in brand new standalone repo in OCN github

## Iterative coding
```{r}
library(tidyverse)
library(here)
```

### for loops
iterative process (do something over and over again)

two major parts: an indexing statement and a command (or set of commands) to repeat. 
*The coding is in base R*
The command looks like this:
for(index in sequence){
command to repeat}

Start with simple code for one year
```{r}
print(paste("The year is", 2000))
```

Put it in for a loop
```{r}
years<-c(2015:2021)
for (i in years){ # set up the for loop where i is the index
  print(paste("The year is", i)) # loop over i
}
```

* Does one thing at a time and can be slow

* Need to test your for loops. sub in i = x and then run the line code to see if it works

* What we just did printed something over and over, but it did not save it anywhere. Let's say you want to save a new vector with all the years. To do this we need to pre-allocate space and tell R where it is going to be saved.
```{r}
#Pre-allocate space for the for loop
# empty matrix that is as long as the years vector
 year_data<-tibble(year =  rep(NA, length(years)),  # column name for year
                   year_name = rep(NA, length(years))) # column name for the year name
year_data
```

Add the for loop
One line at a time. Let's first add in the column that is going to have all the names in it. Notice that I added an index i in the column name. I also am having the index go from 1:length(years), which is 1:7. I use length() because it allows me to change the number of years in the vector without having to change the for loop.

```{r}
for (i in 1:length(years)){ # set up the for loop where i is the index
  year_data$year_name[i]<-paste("The year is", years[i]) # loop over i
}
year_data
```

```{r}
for (i in 1:length(years)){ # set up the for loop where i is the index
  year_data$year_name[i]<-paste("The year is", years[i]) # loop over year name
  year_data$year[i]<-years[i] # loop over year
}
year_data
```

### Use Case
Use these a lot in lab! Do the same things over and over again

Let's say you have multiple data files where you want to perform the same action to each. You can use a for loop to do this.

In the data folder you will see a subfolder called cond_data. Here I have 3 files of salinity and temperature data collected from Mo'orea from a spatial survey.

Read in one of the files so that you can see what it looks like.

```{r}
testdata<-read_csv(here("Week_13", "Data", "011521_CT316_1pcal.csv"))
glimpse(testdata)
```

#### list files in a directory
```{r}
# point to the location on the computer of the folder
CondPath<-here("Week_13", "Data")
# list all the files in that path with a specific pattern
# In this case we are looking for everything that has a .csv in the filename
# you can use regex to be more specific if you are looking for certain patterns in filenames
files <- dir(path = CondPath,pattern = ".csv")
files
```

#### pre-allocate space for the loop
Let's calculate the mean temperature and salinity from each file and save it
```{r}
# pre-allocate space
# make an empty dataframe that has one row for each file and 3 columns
 cond_data<-tibble(filename =  rep(NA, length(files)),  # column name for year
                   mean_temp = rep(NA, length(files)), # column name for the mean temperature
                   mean_sal = rep(NA, length(files)), # column name for the mean salinity
                   ) # column name for the year name
cond_data
```
#### for loop test
write basic code to calculate a mean and build out
```{r}
raw_data<-read_csv(paste0(CondPath,"/",files[1])) # test by reading in the first file and see if it works
head(raw_data)
```
Make sure your path can get you there
```{r}
mean_temp<-mean(raw_data$Temperature, na.rm = TRUE) # calculate a mean
mean_temp
```
Test test test

#### turn it into a for loop
```{r}
for (i in 1:length(files)){ # loop over 1:3 the number of files
}
```
Add in the loop over the raw data to test
```{r}
for (i in 1:length(files)){ # loop over 1:3 the number of files 
raw_data<-read_csv(paste0(CondPath,"/",files[i]))
glimpse(raw_data)
}
```
Add in the columns
```{r}
for (i in 1:length(files)){ # loop over 1:3 the number of files 
raw_data<-read_csv(paste0(CondPath,"/",files[i]))
#glimpse(raw_data)
cond_data$filename[i]<-files[i]
} 
cond_data
```
Add in means
```{r}
for (i in 1:length(files)){ # loop over 1:3 the number of files 
raw_data<-read_csv(paste0(CondPath,"/",files[i]))
#glimpse(raw_data)
cond_data$filename[i]<-files[i]
cond_data$mean_temp[i]<-mean(raw_data$Temperature, na.rm =TRUE)
cond_data$mean_sal[i]<-mean(raw_data$Salinity, na.rm =TRUE)
} 
cond_data
```

However, with the tidyverse you can avoid needing loops for almost any basic coding needs. Where it does come in handy is in population modeling and Bayesian modeling, for example. Also, it is integral to programming and is happening "under the hood" whether you use them or not.

## {purrr}
This is the exact same thing with the cleaner, faster, tidyverse style language
"...it's designed to make your pure functions purrr."

### map functions
The pattern of looping over a vector, doing something to each element and saving the results is so common that the purrr package provides a family of functions to do it for you. There is one function for each type of output:

* map() makes a list.
* map_lgl() makes a logical vector.
* map_int() makes an integer vector.
* map_dbl() makes a double vector.
* map_chr() makes a character vector.
* map_df() makes a dataframe

Each function takes a vector as input, applies a function to each piece, and then returns a new vector thatâ€™s the same length (and has the same names) as the input.

#### Simple Example
There 3 ways to do the same thing in a map() function

*1. Use a canned function that already exists*

Let's calculate the mean from a set of random numbers and do it 10 times

Create a vector from 1:10
```{r}
1:10 # a vector from 1 to 10 (we are going to do this 10 times)
```
for each time 1:10 make a vector of 15 random numbers based on a normal distribution
```{r}
1:10 %>% # a vector from 1 to 10 (we are going to do this 10 times) %>% # the vector to iterate over
  map(rnorm, n = 15) # calculate 15 random numbers based on a normal distribution in a list
```
Calculate the mean from each list
```{r}
1:10 %>% # a vector from 1 to 10 (we are going to do this 10 times) %>% # the vector to iterate over
  map(rnorm, n = 15)  %>% # calculate 15 random numbers based on a normal distribution in a list 
  map_dbl(mean) # calculate the mean. It is now a vector which is type "double"
```
And then assign it a name so when you run it the 10 numbers are all you see
*2. Make your own function*
```{r}
1:10 %>% # list 1:10
  map(function(x) rnorm(15, x)) %>% # make your own function
  map_dbl(mean)
```
*3. Use a formula when you want to change the arguements within the function*
```{r}
1:10 %>%
  map(~ rnorm(15, .x)) %>% # changes the arguments inside the function
  map_dbl(mean)
```

### Using purrr instead of for loop
*Find the files*
```{r}
# point to the location on the computer of the folder
CondPath<-here("Week_13", "Data")
files <- dir(path = CondPath,pattern = ".csv")
files
```
Map likes the full file names so let's add that
```{r}
files <- dir(path = CondPath,pattern = ".csv", full.names = TRUE)
#save the entire path name
files
```
*Read in the files*
```{r}
data<-files %>%
  set_names()%>% # set's the id of each list to the file name
  map_df(read_csv,.id = "filename") # map everything to a dataframe and put the id in a column called filename
data
```
Data frame columns MUST be identical for this to run w/o error
*Calculate means*
```{r}
data<-files %>%
  set_names()%>% # set's the id of each list to the file name
  map_df(read_csv,.id = "filename") %>% # map everything to a dataframe and put the id in a column called filename
  group_by(filename) %>%
  summarise(mean_temp = mean(Temperature, na.rm = TRUE),
            mean_sal = mean(Salinity,na.rm = TRUE))
data
```
THIS IS SUPER USEFUL GET W IT!
[R4DS](https://r4ds.had.co.nz/iteration.html)
[Advanced R](https://adv-r.hadley.nz/functionals.html)
